version: 1
kind: stack
meta:
  name: Kubeflow

requires:
  - gcp
  - kubernetes

extensions:
  include:
    - params.yaml
    - params-dex.yaml
    - params-minio.yaml
    - params-mysql.yaml
    - params-istio.yaml
    - params-nginx.yaml
    - params-argo.yaml
    - params-kubeflow.yaml
    - params-kubeflow-jupyter.yaml
    - params-kubeflow-pipelines.yaml
    - params-kubeflow-tensorboard.yaml
    - params-kubeflow-katib.yaml
    - params-kserve.yaml
    - params-seldon.yaml
    - params-replikate.yaml
  init:
    - gcp
  configure:
    - gcp
    - bin/configure-gke
    - bin/gen-oidc-secrets
    - kubernetes
    - env
  deploy:
    before:
      - bin/check-gke-running

components:
  - name: external-dns
    source:
      dir: components/external-dns
      git:
        remote: https://github.com/agilestacks/google-components.git
        subDir: external-dns
        ref: tags/v1.5.0
    hooks:
      - file: bin/create-dns-admin-sa
        triggers: [pre-deploy]
      - file: bin/delete-dns-admin-sa
        triggers: [post-undeploy]
      - file: bin/patch-kube-sa
        triggers: [post-deploy]

  - name: cert-manager
    source:
      dir: components/cert-manager
      git:
        remote: https://github.com/agilestacks/google-components.git
        subDir: cert-manager
        ref: tags/v1.5.0

  - name: nginx
    source:
      dir: components/nginx
      git:
        remote: https://github.com/agilestacks/google-components.git
        subDir: nginx
        ref: tags/v1.5.0
    depends:
      - cert-manager
      - external-dns

  - name: istio
    source:
      dir: components/istio
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: istio
        ref: tags/v1.5.0

  - name: istio-ingressgateway
    source:
      dir: components/istio-ingressgateway
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: istio-ingressgateway
        ref: tags/v1.5.0
    depends:
      - istio

  - name: dex
    source:
      dir: components/dex
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: dex
        ref: tags/v1.5.0

  - name: minio
    source:
      dir: components/minio
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: minio
        ref: tags/v1.5.0

  - name: kserve-etcd
    source:
      dir: components/etcd
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: etcd
        ref: tags/v1.5.0

  - name: mysql-argo
    source:
      dir: components/mysql
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: mysql
        ref: tags/v1.5.0

  - name: mysql-pipeline
    source:
      dir: components/mysql
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: mysql
        ref: tags/v1.5.0

  - name: mysql-katib
    source:
      dir: components/mysql
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: mysql
        ref: tags/v1.5.0

  - name: mysql-metadata
    source:
      dir: components/mysql
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: mysql
        ref: tags/v1.5.0

  - name: argo
    source:
      dir: components/argo
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: argo
        ref: tags/v1.5.0
    depends:
      - mysql-argo
      - minio
      - dex

  - name: kubeflow-common
    source:
      dir: components/kubeflow-common
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-common
        ref: tags/v1.5.0
    depends:
      - dex

  - name: kubeflow-rbac
    source:
      dir: components/kubeflow-rbac
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-common
        ref: tags/v1.5.0
    depends:
      - dex
      - kubeflow-common

  - name: kubeflow-authn
    source:
      dir: components/kubeflow-authn
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-authn
        ref: tags/v1.5.0
    depends:
      - dex
      - kubeflow-common
      - istio

  - name: kubeflow-profiles
    source:
      dir: components/kubeflow-profiles
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-profiles
        ref: tags/v1.5.0
    depends:
      - istio
      - kubeflow-authn
      - kubeflow-common

  - name: kubeflow-centraldashboard
    source:
      dir: components/kubeflow-centraldashboard
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-centraldashboard
        ref: tags/v1.5.0
    depends:
      - istio-ingressgateway
      - kubeflow-common
      - kubeflow-rbac
      - kubeflow-profiles

  - name: kubeflow-jupyter
    source:
      dir: components/kubeflow-jupyter
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-jupyter
        ref: tags/v1.5.0
    depends:
      - istio-ingressgateway
      - kubeflow-common
      - kubeflow-profiles
      - kubeflow-rbac
      - kubeflow-webhooks

  - name: kubeflow-tensorboard
    source:
      dir: components/kubeflow-tensorboard
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-tensorboard
        ref: tags/v1.5.0
    depends:
      - kubeflow-common
      - kubeflow-profiles
      - kubeflow-rbac
      - istio-ingressgateway

  - name: kubeflow-volumes
    source:
      dir: components/kubeflow-volumes
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-volumes
        ref: tags/v1.5.0
    depends:
      - kubeflow-common
      - kubeflow-profiles
      - kubeflow-rbac
      - istio-ingressgateway

  - name: katib
    source:
      dir: components/kubeflow-katib
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-katib
        ref: tags/v1.5.0
    depends:
      - kubeflow-common
      - kubeflow-rbac
      - mysql-katib

  - name: kubeflow-metadata
    source:
      dir: components/kubeflow-metadata
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-metadata
        ref: tags/v1.5.0
    depends:
      - kubeflow-common
      - kubeflow-rbac
      - mysql-metadata

  - name: kubeflow-pipelines
    source:
      dir: components/kubeflow-pipeline
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-pipeline
        ref: tags/v1.5.0
    depends:
      - kubeflow-profiles
      - kubeflow-metadata
      - mysql-metadata
      - minio

  - name: knative
    source:
      dir: components/knative
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: knative
        ref: tags/v1.5.0

  - name: kserve
    source:
      dir: components/kserve
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kserve
        ref: tags/v1.5.0
    depends:
      - istio-ingressgateway
      - kubeflow-common
      - knative
      - kserve-etcd

  # - name: kubebench
  #   source:
  #     dir: components/kubebench
  #     git:
  #       remote: https://github.com/agilestacks/kubeflow-components.git
  #       subDir: kubebench
  #       ref: tags/v1.5.0
  #   depends:
  #   - istio-ingressgateway

  - name: kubeflow-webhooks
    source:
      dir: components/kubeflow-webhooks
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-webhooks
        ref: tags/v1.5.0
    depends:
      - kubeflow-rbac
      - kubeflow-common

  # - name: kubeflow-tf-training
  #   source:
  #     dir: components/kubeflow-tf-training
  #     git:
  #       remote: https://github.com/agilestacks/kubeflow-components.git
  #       subDir: kubeflow-tf-training
  #       ref: tags/v1.5.0
  #   depends:
  #   - kubeflow-rbac
  #   - kubeflow-common

  - name: kubeflow-training-operator
    source:
      dir: components/kubeflow-training-operator
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: kubeflow-training-operator
        ref: tags/v1.5.0
    depends:
      - kubeflow-rbac
      - kubeflow-common

  - name: seldon-core
    source:
      dir: components/seldon-core-operator
      git:
        remote: https://github.com/agilestacks/kubeflow-components.git
        subDir: seldon-core
        ref: tags/v1.5.0
    depends:
      - istio-ingressgateway

  - name: replikate
    source:
      dir: components/replikate
      git:
        remote: https://github.com/agilestacks/kubeflow-stacks.git
        subDir: apps/replikate/kustomize
        ref: tags/v1.5.0
    depends:
      - minio
      - istio-ingressgateway
      - kubeflow-pipelines
      - istio
