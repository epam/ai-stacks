#!/bin/bash -e

PATH="$(which hub-state)/bin:$HOME/.hub/bin:$PATH"
export PATH

DEX_USER="$1"
if test -z "$DEX_USER"; then
    echo "Usage: $0 <dex-user> [password]" >&2
    exit 1
fi

trap "exit" INT TERM ERR
trap "kill 0" EXIT

NS="$(params value dex.namespace)"
if test -z "$NS"; then
    NS="kube-ingress"
fi

echo "Starting port forward for dex.$NS.svc.cluster.local:5557"
kubectl -n "$NS"  port-forward svc/dex 5557 &

sleep 3

echo "Resetting password for user $DEX_USER"

pass="$2"
if test -z "$pass"; then
    echo "Generating random password"
    pass="$(uuidgen | tr '[:upper:]' '[:lower:]' | tr -d -)"
fi

dexctl create password -e "$DEX_USER" -p "$pass" >/dev/null 2>&1 \
|| dexctl update password -e "$DEX_USER" -n "$DEX_USER" -p "$pass" 2>/dev/null

echo -n "New password: "
color h "$pass"
